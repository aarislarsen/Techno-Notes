<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Techno-Notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0d1117;
            min-height: 100vh;
            padding: 20px;
            color: #c9d1d9;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #30363d;
        }

        header {
            background: linear-gradient(135deg, #f0883e 0%, #d97706 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            opacity: 0.95;
            font-size: 1.1em;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #30363d;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h2 {
            color: #e6edf3;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        #dropzone {
            border: 3px dashed #30363d;
            border-radius: 8px;
            padding: 60px;
            text-align: center;
            background: #21262d;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        #dropzone:hover:not(.disabled) {
            border-color: #f0883e;
            background: #2d333b;
        }

        #dropzone.drag-over {
            border-color: #f0883e;
            background: #2d333b;
            transform: scale(1.02);
        }

        #dropzone.disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        #dropzone p {
            font-size: 1.2em;
            color: #8b949e;
        }

        #prompt-editor {
            width: 100%;
            height: 150px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            border: 2px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            background: #21262d;
            color: #c9d1d9;
        }

        #prompt-editor:focus {
            outline: none;
            border-color: #f0883e;
        }

        button {
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            background: #f0883e;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 136, 62, 0.4);
        }

        button:disabled {
            background: #30363d;
            color: #6e7681;
            cursor: not-allowed;
            transform: none;
        }

        button.success {
            background: #238636;
        }

        button.success:hover:not(:disabled) {
            background: #2ea043;
        }

        #status, .status-box {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
        }

        .success {
            background: #1a472a;
            color: #7ee787;
            border-left: 4px solid #238636;
        }

        .error {
            background: #4c1f1f;
            color: #f85149;
            border-left: 4px solid #da3633;
        }

        .warning {
            background: #3d2e00;
            color: #f0883e;
            border-left: 4px solid #d97706;
        }

        .info {
            background: #1c2a3a;
            color: #79c0ff;
            border-left: 4px solid #58a6ff;
        }

        .progress-bar {
            width: 100%;
            height: 35px;
            background: #21262d;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f0883e 0%, #d97706 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(240, 136, 62, 0.3);
            border-top: 3px solid #f0883e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        select {
            padding: 10px 15px;
            margin: 5px;
            font-size: 14px;
            border: 2px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #f0883e;
        }

        .hidden {
            display: none;
        }

        #setup-log {
            background: #21262d;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }

        /* Custom scrollbar for setup log */
        #setup-log::-webkit-scrollbar {
            width: 8px;
        }

        #setup-log::-webkit-scrollbar-track {
            background: #161b22;
        }

        #setup-log::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        #setup-log::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        .setup-message {
            padding: 3px 0;
            color: #8b949e;
        }

        .setup-message:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        label {
            font-weight: 600;
            color: #c9d1d9;
            display: block;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            font-size: 14px;
            border: 2px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #c9d1d9;
            margin: 8px 0;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #f0883e;
        }

        .api-config-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .provider-section {
            background: #21262d;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #30363d;
            margin: 10px 0;
        }

        .provider-section.active {
            border-color: #f0883e;
        }

        .inline-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .small-button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .radio-group label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
        }

        .radio-group input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #0d1117;
            color: #8b949e;
            font-size: 14px;
            border-top: 1px solid #30363d;
        }

        footer a {
            color: #f0883e;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
            color: #d97706;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÑ Techno-Notes</h1>
            <p>Analyze PDF documents with AI - Local Ollama or Cloud APIs</p>
        </header>
        
        <div id="setup-section" class="section">
            <h2>‚öôÔ∏è System Setup</h2>
            <div class="status-box info" id="setup-status">Checking system status...</div>
            
            <div id="setup-controls" class="hidden">
                <label>Select LLM Model:</label>
                <select id="model-select">
                    <option value="llama2">llama2 (7B) - Recommended</option>
                    <option value="llama2:13b">llama2:13b (13B) - Better Quality</option>
                    <option value="llama3.2:1b">llama3.2:1b (1B) - Fastest</option>
                    <option value="llama3.2:3b">llama3.2:3b (3B) - Fast</option>
                    <option value="mistral">mistral (7B) - Efficient</option>
                    <option value="phi">phi (2.7B) - Small & Fast</option>
                </select>
                <button onclick="startAutoSetup()" class="success" id="setup-btn">
                    üì• Download Model & Start Service
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    ‚è±Ô∏è Model download may take 5-15 minutes depending on your connection and model size
                </p>
            </div>
            
            <div id="progress-container" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill">0%</div>
                </div>
                <div id="setup-log"></div>
            </div>
        </div>
        
        <div id="main-section" class="section hidden">
            <h2>ü§ñ LLM Provider Configuration</h2>
            <p style="margin-bottom: 15px; color: #8b949e;">Choose between local Ollama or cloud-based API providers</p>

            <div class="radio-group">
                <label>
                    <input type="radio" name="provider" value="ollama" checked onchange="updateProviderSelection()">
                    Local Ollama (Private)
                </label>
                <label>
                    <input type="radio" name="provider" value="chatgpt" onchange="updateProviderSelection()">
                    ChatGPT (OpenAI API)
                </label>
                <label>
                    <input type="radio" name="provider" value="perplexity" onchange="updateProviderSelection()">
                    Perplexity AI
                </label>
            </div>

            <div id="ollama-config" class="provider-section active">
                <h3 style="margin-bottom: 15px; color: #e6edf3;">Local Ollama Configuration</h3>
                <p style="color: #8b949e; margin-bottom: 10px;">Using local model - All data stays on your machine</p>
            </div>

            <div id="chatgpt-config" class="provider-section hidden">
                <h3 style="margin-bottom: 15px; color: #e6edf3;">ChatGPT API Configuration</h3>
                <label for="chatgpt-api-key">OpenAI API Key:</label>
                <input type="password" id="chatgpt-api-key" placeholder="sk-...">
                <label for="chatgpt-model">Model:</label>
                <select id="chatgpt-model">
                    <option value="gpt-4o-mini">GPT-4o Mini (Recommended - Fast & Cheap)</option>
                    <option value="gpt-4o">GPT-4o (Most Capable)</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fastest & Cheapest)</option>
                </select>
                <div class="inline-buttons">
                    <button onclick="saveAPIKey('chatgpt')" class="small-button">üíæ Save API Key</button>
                    <button onclick="testAPIConnection('chatgpt')" class="small-button">üîó Test Connection</button>
                </div>
                <div id="chatgpt-status"></div>
            </div>

            <div id="perplexity-config" class="provider-section hidden">
                <h3 style="margin-bottom: 15px; color: #e6edf3;">Perplexity AI Configuration</h3>
                <label for="perplexity-api-key">Perplexity API Key:</label>
                <input type="password" id="perplexity-api-key" placeholder="pplx-...">
                <label for="perplexity-model">Model:</label>
                <select id="perplexity-model">
                    <option value="llama-3.1-sonar-small-128k-online">Llama 3.1 Sonar Small 128k (Recommended)</option>
                    <option value="llama-3.1-sonar-large-128k-online">Llama 3.1 Sonar Large 128k</option>
                    <option value="llama-3.1-sonar-huge-128k-online">Llama 3.1 Sonar Huge 128k</option>
                </select>
                <div class="inline-buttons">
                    <button onclick="saveAPIKey('perplexity')" class="small-button">üíæ Save API Key</button>
                    <button onclick="testAPIConnection('perplexity')" class="small-button">üîó Test Connection</button>
                </div>
                <div id="perplexity-status"></div>
            </div>

            <h2 style="margin-top: 40px;">üìù Prompt Configuration</h2>
            <label for="prompt-editor">Customize how the AI analyzes your documents:</label>
            <textarea id="prompt-editor" placeholder="Enter your analysis prompt..."></textarea>
            <button onclick="savePrompt()">üíæ Save Prompt</button>
            
            <h2 style="margin-top: 40px;">üì§ Upload PDF</h2>
            <div id="dropzone" class="disabled">
                <p>üìÑ Drag and drop PDF here or click to select</p>
                <p style="font-size: 0.9em; color: #999; margin-top: 10px;">Maximum file size: 50MB</p>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            </div>
            
            <div id="status"></div>
        </div>
        
        <footer>
            <p>üîí Choose your provider: Local Ollama (private) or API (ChatGPT/Perplexity)</p>
            <p style="margin-top: 10px;">
                Powered by <a href="https://ollama.ai" target="_blank">Ollama</a>,
                <a href="https://openai.com" target="_blank">OpenAI</a>, and
                <a href="https://perplexity.ai" target="_blank">Perplexity</a>
            </p>
        </footer>
    </div>

    <script>
        let systemReady = false;
        let statusCheckInterval;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkSetupStatus() {
            try {
                const response = await fetch('/setup_status');
                if (!response.ok) {
                    throw new Error('Status check failed');
                }
                const status = await response.json();
                
                updateSetupUI(status);
                
                if (status.ready) {
                    systemReady = true;
                    document.getElementById('setup-section').classList.add('hidden');
                    document.getElementById('main-section').classList.remove('hidden');
                    document.getElementById('dropzone').classList.remove('disabled');
                    loadPrompt();
                    loadProviderConfig();

                    if (statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                    }
                } else {
                    if (status.progress.stage === 'idle') {
                        document.getElementById('setup-controls').classList.remove('hidden');
                        document.getElementById('progress-container').classList.add('hidden');
                    } else {
                        document.getElementById('setup-controls').classList.add('hidden');
                        document.getElementById('progress-container').classList.remove('hidden');
                        updateProgress(status.progress);
                    }
                }
            } catch (error) {
                console.error('Status check failed:', error);
                const statusBox = document.getElementById('setup-status');
                statusBox.className = 'status-box error';
                statusBox.textContent = '‚úó Failed to check system status. Please refresh the page.';
            }
        }

        function updateSetupUI(status) {
            const statusBox = document.getElementById('setup-status');
            
            if (status.ready) {
                statusBox.className = 'status-box success';
                statusBox.innerHTML = `‚úì System Ready - Model: ${escapeHtml(status.model_name)}`;
            } else if (status.progress.error) {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `‚úó Setup Error: ${escapeHtml(status.progress.error)}`;
                document.getElementById('setup-controls').classList.remove('hidden');
                document.getElementById('progress-container').classList.add('hidden');
            } else if (status.progress.stage !== 'idle') {
                statusBox.className = 'status-box info';
                statusBox.innerHTML = `<span class="spinner"></span> ${escapeHtml(status.progress.message)}`;
            } else {
                statusBox.className = 'status-box warning';
                statusBox.innerHTML = '‚ö†Ô∏è Setup Required - Click button below to begin automatic installation';
            }
        }

        function updateProgress(progress) {
            const fill = document.getElementById('progress-fill');
            const log = document.getElementById('setup-log');
            
            const progressPercent = Math.min(100, Math.max(0, progress.progress));
            fill.style.width = progressPercent + '%';
            fill.textContent = progressPercent + '%';
            
            const logEntry = document.createElement('div');
            logEntry.className = 'setup-message';
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${progress.message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        async function startAutoSetup() {
            const modelName = document.getElementById('model-select').value;
            const setupBtn = document.getElementById('setup-btn');
            
            setupBtn.disabled = true;
            setupBtn.innerHTML = '<span class="spinner"></span> Setting up...';
            
            document.getElementById('setup-controls').classList.add('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            
            try {
                const response = await fetch('/auto_setup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({model_name: modelName})
                });
                
                if (!response.ok) {
                    throw new Error('Setup failed to start');
                }
                
                statusCheckInterval = setInterval(checkSetupStatus, 2000);
            } catch (error) {
                console.error('Setup failed:', error);
                showStatus('‚ùå Setup initiation failed. Please try again.', 'error');
                setupBtn.disabled = false;
                setupBtn.textContent = 'üì• Download Model & Start Service';
                document.getElementById('setup-controls').classList.remove('hidden');
                document.getElementById('progress-container').classList.add('hidden');
            }
        }

        async function loadPrompt() {
            try {
                const response = await fetch('/get_prompt');
                if (!response.ok) {
                    throw new Error('Failed to load prompt');
                }
                const data = await response.json();
                document.getElementById('prompt-editor').value = data.prompt;
            } catch (error) {
                console.error('Failed to load prompt:', error);
            }
        }

        async function savePrompt() {
            try {
                const response = await fetch('/save_prompt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        prompt: document.getElementById('prompt-editor').value
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save prompt');
                }
                
                showStatus('‚úÖ Prompt saved successfully', 'success');
            } catch (error) {
                console.error('Failed to save prompt:', error);
                showStatus('‚ùå Failed to save prompt', 'error');
            }
        }

        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');

        dropzone.onclick = () => { 
            if (systemReady) {
                fileInput.click(); 
            }
        };
        
        dropzone.ondragover = (e) => {
            if (!systemReady) return;
            e.preventDefault();
            dropzone.classList.add('drag-over');
        };
        
        dropzone.ondragleave = () => {
            dropzone.classList.remove('drag-over');
        };
        
        dropzone.ondrop = (e) => {
            if (!systemReady) return;
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        };
        
        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        };

        async function handleFile(file) {
            if (!file) {
                showStatus('‚ùå No file selected', 'error');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showStatus('‚ùå Please select a PDF file', 'error');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showStatus('‚ùå File too large (max 50MB)', 'error');
                return;
            }

            showStatus('‚è≥ Processing PDF... This may take a few minutes.', 'info');
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/process_pdf', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Processing failed');
                }
                
                const a = document.createElement('a');
                a.href = `/download/${encodeURIComponent(data.output_file)}`;
                a.download = data.original_name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showStatus('‚úÖ Processing complete! Download started.', 'success');
                
                fileInput.value = '';
                
            } catch (error) {
                console.error('Processing error:', error);
                showStatus(`‚ùå Error: ${escapeHtml(error.message)}`, 'error');
            }
        }

        function showStatus(msg, type) {
            status.textContent = msg;
            status.className = type;

            if (type === 'success') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = '';
                }, 5000);
            }
        }

        function showProviderStatus(provider, msg, type) {
            const statusDiv = document.getElementById(`${provider}-status`);
            statusDiv.textContent = msg;
            statusDiv.className = type;

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = '';
                }, 5000);
            }
        }

        async function updateProviderSelection() {
            const provider = document.querySelector('input[name="provider"]:checked').value;

            // Hide all provider configs
            document.getElementById('ollama-config').classList.add('hidden');
            document.getElementById('chatgpt-config').classList.add('hidden');
            document.getElementById('perplexity-config').classList.add('hidden');

            // Show selected provider config
            document.getElementById(`${provider}-config`).classList.remove('hidden');

            // Update active state
            document.querySelectorAll('.provider-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${provider}-config`).classList.add('active');

            // Save provider selection and model
            let apiModel = null;
            if (provider === 'chatgpt') {
                apiModel = document.getElementById('chatgpt-model').value;
            } else if (provider === 'perplexity') {
                apiModel = document.getElementById('perplexity-model').value;
            }

            try {
                await fetch('/set_provider', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        api_model: apiModel
                    })
                });
            } catch (error) {
                console.error('Failed to save provider:', error);
            }
        }

        async function saveAPIKey(provider) {
            const apiKeyInput = document.getElementById(`${provider}-api-key`);
            const modelSelect = document.getElementById(`${provider}-model`);
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                showProviderStatus(provider, '‚ùå Please enter an API key', 'error');
                return;
            }

            try {
                const response = await fetch('/save_api_key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        api_key: apiKey
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to save API key');
                }

                // Also save the model selection
                await fetch('/set_provider', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        api_model: modelSelect.value
                    })
                });

                showProviderStatus(provider, '‚úÖ API key saved successfully', 'success');
            } catch (error) {
                console.error('Failed to save API key:', error);
                showProviderStatus(provider, `‚ùå ${error.message}`, 'error');
            }
        }

        async function testAPIConnection(provider) {
            const modelSelect = document.getElementById(`${provider}-model`);
            const model = modelSelect.value;

            showProviderStatus(provider, '‚è≥ Testing connection...', 'info');

            try {
                const response = await fetch('/test_api_connection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        model: model
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Connection test failed');
                }

                showProviderStatus(provider, `‚úÖ Connection successful! Using ${data.model}`, 'success');
            } catch (error) {
                console.error('Connection test failed:', error);
                showProviderStatus(provider, `‚ùå ${error.message}`, 'error');
            }
        }

        async function loadProviderConfig() {
            try {
                // Load current provider
                const providerResponse = await fetch('/get_provider');
                if (providerResponse.ok) {
                    const data = await providerResponse.json();
                    if (data.success) {
                        const provider = data.provider || 'ollama';
                        const apiModel = data.api_model || 'gpt-4o-mini';

                        // Set radio button
                        const radio = document.querySelector(`input[name="provider"][value="${provider}"]`);
                        if (radio) {
                            radio.checked = true;
                        }

                        // Set model selects
                        if (provider === 'chatgpt') {
                            document.getElementById('chatgpt-model').value = apiModel;
                        } else if (provider === 'perplexity') {
                            document.getElementById('perplexity-model').value = apiModel;
                        }

                        // Update UI to show correct provider section
                        updateProviderSelection();
                    }
                }

                // Load API keys
                for (const provider of ['chatgpt', 'perplexity']) {
                    const response = await fetch('/get_api_key', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({provider: provider})
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.api_key) {
                            document.getElementById(`${provider}-api-key`).value = data.api_key;
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load provider config:', error);
            }
        }

        checkSetupStatus();

        setInterval(() => {
            if (!statusCheckInterval && !systemReady) {
                checkSetupStatus();
            }
        }, 30000);
    </script>
</body>
</html>